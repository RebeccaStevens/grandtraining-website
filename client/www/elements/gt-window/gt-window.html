<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">

<dom-module id="gt-window">
  <style>
    :host {
      display: block;
      border: var(--gt-window-bezal-border, solid 1px navy);
      background-color: var(--gt-window-bezal-color, lightblue);
      position: relative;
      margin: 8px 8px 8px 2px;
    }
    #bezal {
      background-color: var(--gt-window-background-color, white);
      border: var(--gt-window-bezal-border, solid 1px navy);
      position: absolute;
      top: 30px;
      right: 6px;
      bottom: 6px;
      left: 6px;
      @apply(--layout-vertical);
    }
    #ribbon-menu {
      height: 26px;
      border-bottom: var(--gt-window-ribbon-border-bottom, solid 1px navy);
    }
    #ribbon-menu paper-tab {
      flex: 0;
      padding: 0 60px;
      border-style: solid;
      border-top-width: 1px;
      border-right-width: 1px;
      border-bottom-width: 0;
      border-left-width: 1px;
      border-color: transparent;
      box-sizing: border-box;
      --paper-tab-ink: var(--gt-window-ribbon-ink, lightblue);
      --paper-tab-content: {
        opacity: 1 !important;
        font-weight: normal !important;
      };
      @apply(--gt-window-ribbon-tab);
    }
    #ribbon-menu paper-tab.iron-selected {
      background-color: #f5f6f7;
      border-color: #dadbdc;
    }
    #ribbon-menu paper-tab:first-of-type {
      border: none;
      @apply(--gt-window-first-ribbon-tab);
    }
    #ribbon-menu paper-tab.iron-selected:first-of-type {
      background-color: #1268b3 !important;
    }
    #ribbon-tabs-btns {
      padding: 0 1px;
      @apply(--layout-flex);
      @apply(--layout-horizontal);
      @apply(--layout-center);
      @apply(--layout-end-justified);
    }
    #ribbon-tabs-btns .btn {
      width: 24px;
      height: 24px;
      padding: 1px;
      box-sizing: border-box;
    }
    #ribbon-tabs-btns .btn:hover,
    #ribbon-tabs-btns .btn:focus {
      padding: 0;
      border: solid 1px #abd4fe;
      background: #f1f7fe;
    }
    #ribbon-tabs-btns .btn:active {
      padding: 0;
      border: solid 1px #66a6e7;
      background: #d1e7fe;
    }
    #expand-ribbon-btn,
    #minimize-ribbon-btn {
      color: #a6a6a6;
    }
    #help-btn {
      color: #0078d7;
    }
    #content {
      position: relative;
      overflow: auto;
      @apply(--layout-flex);
    }
    #title-bar {
      text-align: center;
      height: 30px;
      font-size: var(--gt-window-title-bar-font-size, 12pt);
      font-family: var(--gt-window-title-bar-font-family, sans-serif);
      @apply(--layout-vertical);
      @apply(--layout-center-justified);
    }
    #window-icon {
      position: absolute;
      top: 0;
      left: 0;
      width: 30px;
      height: 30px;
      @apply(--layout-vertical);
      @apply(--layout-center-justified);
    }
    #window-icon > div {
      @apply(--layout-horizontal);
      @apply(--layout-center-justified);
    }
    /* start control-box */
    #control-box {
      position: absolute;
      top: 0;
      right: 6px;
      @apply(--layout-horizontal);
    }
    #control-box > .control{
      width: 45px;
      height: 30px;
      margin-left: 1px;
      @apply(--gt-window-control-box-button);
    }
    #minimize {
      @apply(--gt-window-minimize-button);
    }
    #minimize:hover {
      background-color: var(--gt-window-minimize-button-color-hover, lightgrey);
      @apply(--gt-window-minimize-button-hover);
    }
    #minimize:active {
      background-color: var(--gt-window-minimize-button-color-active, grey);
      @apply(--gt-window-minimize-button-active);
    }
    #maximize {
      @apply(--gt-window-maximize-button);
    }
    #maximize:hover {
      background-color: var(--gt-window-maximize-button-color-hover, lightgrey);
      @apply(--gt-window-maximize-button-hover);
    }
    #maximize:active {
      background-color: var(--gt-window-maximize-button-color-active, grey);
      @apply(--gt-window-maximize-button-active);
    }
    #restore {
      @apply(--gt-window-restore-button);
    }
    #restore:hover {
      background-color: var(--gt-window-maximize-button-color-hover, lightgrey);
      @apply(--gt-window-restore-button-hover);
    }
    #restore:active {
      background-color: var(--gt-window-maximize-button-color-active, grey);
      @apply(--gt-window-restore-active);
    }
    #close {
      @apply(--gt-window-close-button);
    }
    #close:hover {
      background-color: var(--gt-window-close-button-color-hover, red);
      @apply(--gt-window-close-button-hover);
    }
    #close:active {
      background-color: var(--gt-window-close-button-color-active, darkred);
      @apply(--gt-window-close-button-active);
    }
    /* end control-box */
  </style>
  <template>
    <div id="control-box">
      <div id="minimize" class="control" title="Minimize" role="button"></div>
      <div id="maximize" class="control" title="Maximize" role="button" hidden$="{{maximized}}"></div>
      <div id="restore" class="control" title="Restore" role="button" hidden$="{{!maximized}}"></div>
      <div id="close" class="control" title="Close" role="button"></div>
    </div>
    <div id="window-icon"><div><content select=".window-icon"></content></div></div>
    <div id="title-bar" class="flex"><span>{{windowTitle}}</span></div>
    <div id="bezal">
      <div id="ribbons">
        <paper-tabs id="ribbon-menu" no-bar selected="{{_selectedRibbon}}">
          <template is="dom-repeat" items="{{_ribbonMenus}}">
            <paper-tab on-tap="_onRibbonTap">{{item.dataset.ribbonTitle}}</paper-tab>
          </template>
          <div id="ribbon-tabs-btns">
            <paper-icon-button icon="icons:arrow-drop-up" noink id="minimize-ribbon-btn" class="btn"
              title="Minimize the Ribbon" on-tap="minimizeRibbon" hidden$="{{!ribbonExpanded}}"></paper-icon-button>
            <paper-icon-button icon="icons:arrow-drop-down" noink id="expand-ribbon-btn" class="btn"
              title="Expand the Ribbon" on-tap="expandRibbon" hidden$="{{ribbonExpanded}}"></paper-icon-button>
            <paper-icon-button icon="icons:help" noink id="help-btn" class="btn"
              title="Help" on-tap="showHelp"></paper-icon-button>
          </div>
        </paper-tabs>
        <iron-pages id="ribbon" selected="{{_selectedRibbon}}" hidden$="{{!hasActiveRibbon}}">
          <content id="ribbonMenus" select=".ribbon-menu"></content>
        </iron-pages>
      </div>
      <div id="content">
        <content></content>
      </div>
    </div>
  </template>
</dom-module>
<script>
  (function() {
    'use strict';
    class GTWindow {

      /**
       * The name of this element.
       *
       * @return {String}
       */
      get is() {
        return 'gt-window';
      }

      /**
       * This element's properties.
       *
       * @return {Object}
       */
      get properties() {
        return {
          /**
           * The text display in the titlebar of the window.
           */
          windowTitle: {
            type: String,
            value: ''
          },

          /**
           * Whether or not the window is maximized.
           */
          maximized: {
            type: Boolean,
            value: false
          },

          /**
           * The active ribbon menu.
           */
          activeRibbon: {
            type: Number,
            value: undefined
          },

          /**
           * Whether or not there is an active ribbon.
           */
          hasActiveRibbon: {
            type: Boolean,
            computed: '_notUndefined(activeRibbon)'
          },

          /**
           * Whether the ribbon is expanded or not.
           */
          ribbonExpanded: {
            type: Boolean,
            value: false
          },

          /**
           * The distribute ribbon menus.
           */
          _ribbonMenus: {
            type: Array,
            readOnly: true,
            value: []
          }
        };
      }

      /**
       * Called when the element is attached to its parent DOM.
       */
      attached() {
        // set the distributed ribbon menus
        this.async(function(){
          this.updateRibbonMenuTabs();
        });
        Polymer.dom(document).node.addEventListener('click', this._documentClick.bind(this), true);
      }

      /**
       * expand the ribbon (stop it being minimized).
       */
      expandRibbon() {
        this.ribbonExpanded = true;
        this._ribbonMenus.forEach((e) => e.removeAttribute('overlay'));
        this._openRibbon(1);
      }

      /**
       * Minimize the ribbon (stop it being expanded).
       */
      minimizeRibbon() {
        this.ribbonExpanded = false;
        this._ribbonMenus.forEach((e) => e.setAttribute('overlay', true));
        this._closeRibbon();
      }

      /**
       * Display a help screen to the user.
       */
      showHelp() {
        console.error('help screen not imlemented yet.');
      }

      /**
       * Update the ribbon menu tabs.
       */
      updateRibbonMenuTabs() {
        // jshint -W106
        this._set_ribbonMenus(Polymer.dom(this.$.ribbonMenus).getDistributedNodes());
        if (this.ribbonExpanded) {
          this._ribbonMenus.forEach((e) => e.removeAttribute('overlay'));
        }
        else {
          this._ribbonMenus.forEach((e) => e.setAttribute('overlay', true));
        }
      }

      /**
       * Called when a ribbon tab is tapped.
       */
      _onRibbonTap(e) {
        let target = e.currentTarget;   // the element that was tapped
        let index = Polymer.dom(target).parentNode.indexOf(target);   // the index of that element

        if (this.activeRibbon === index && !this.ribbonExpanded) {
          this.activeRibbon = undefined;
        }
        else {
          this.activeRibbon = index;
        }
      }

      /**
       * Close the currently active ribbon.
       */
      _closeRibbon() {
        if (this.hasActiveRibbon && !this.ribbonExpanded) {
          Polymer.dom(this.$['ribbon-menu']).children[this.activeRibbon].click();
        }
      }

      /**
       * Open a ribbon.
       *
       * @param {integer} index - The index of the ribbon to open
       */
      _openRibbon(index) {
        if (!this.hasActiveRibbon) {
          Polymer.dom(this.$['ribbon-menu']).children[index].click();
        }
      }

      /**
       * Called when the users clicks anywhere on the document.
       *
       * @param {Object} e - The event
       */
       _documentClick(e) {
         let outsideRibbonMenu = true;

         // starting from the node the user clicked on, search up the DOM tree
         let node = Polymer.dom(e).rootTarget;
         while (node !== null) {
           if (node.id === 'ribbons') {
             outsideRibbonMenu = false;
           }
           node = node.parentNode;
         }

         // didn't click on the ribbon
         if (outsideRibbonMenu) {
           this._closeRibbon();
         }
       }

      /**
       * Return whether or not the give value is undefined.
       *
       * @param {*} value - The value to test
       * @return {Boolean}
       */
      _notUndefined(value) {
        return value !== undefined;
      }
    }

    Polymer(GTWindow);
  })();
</script>
